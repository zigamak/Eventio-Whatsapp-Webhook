<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventio â€” Messages</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand:        #452869;
            --brand-dark:   #321d4f;
            --brand-light:  #5a3780;
            --brand-pale:   #ede8f5;
            --sent-bg:      #DCF8C6;
            --sent-dark:    #c5eaae;
            --received-bg:  #ffffff;
            --chat-bg:      #eae6df;
            --sidebar-bg:   #ffffff;
            --header-bg:    #452869;
            --text-primary: #111827;
            --text-secondary:#6b7280;
            --text-muted:   #9ca3af;
            --border:       #e5e7eb;
            --tick-grey:    #8c9aab;
            --tick-blue:    #34b7f1;
            --online:       #25d366;
            --shadow-sm:    0 1px 3px rgba(0,0,0,.08);
            --shadow-md:    0 4px 12px rgba(0,0,0,.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--chat-bg);
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
        }

        /* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            box-shadow: 0 0 60px rgba(0,0,0,.25);
        }

        /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            width: 360px;
            min-width: 300px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            transition: transform .3s ease;
        }

        .sidebar-header {
            background: var(--header-bg);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .sidebar-header .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-name {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: .3px;
        }

        .header-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,.85);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,.15); color: #fff; }

        .search-wrap {
            padding: 10px 12px;
            background: #f0f2f5;
            border-bottom: 1px solid var(--border);
        }

        .search-inner {
            display: flex;
            align-items: center;
            background: #fff;
            border-radius: 8px;
            padding: 7px 12px;
            gap: 8px;
            border: 1px solid var(--border);
            transition: border-color .2s, box-shadow .2s;
        }
        .search-inner:focus-within {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(69,40,105,.1);
        }

        .search-inner svg { color: var(--text-muted); flex-shrink: 0; }

        .search-inner input {
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-primary);
            width: 100%;
            background: transparent;
        }
        .search-inner input::placeholder { color: var(--text-muted); }

        /* â”€â”€â”€ CHAT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #chats-container {
            flex: 1;
            overflow-y: auto;
        }

        #chats-container::-webkit-scrollbar { width: 4px; }
        #chats-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background .15s;
            position: relative;
        }
        .chat-item:hover { background: #f9fafb; }
        .chat-item.active { background: var(--brand-pale); }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--brand);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 19px;
            font-weight: 600;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .avatar.sm {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }

        .chat-meta { flex: 1; min-width: 0; }

        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 2px;
        }

        .chat-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-name.unread { font-weight: 700; }

        .chat-time {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .chat-time.unread { color: var(--brand); font-weight: 600; }

        .chat-phone {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .chat-preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .chat-preview.unread { color: var(--text-primary); font-weight: 500; }

        .unread-badge {
            min-width: 20px;
            height: 20px;
            background: var(--brand);
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ EMPTY / LOADING STATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .state-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            padding: 32px;
            text-align: center;
            gap: 12px;
        }
        .state-empty svg { opacity: .35; }
        .state-empty p { font-size: 14px; }

        /* â”€â”€â”€ CHAT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
            position: relative;
        }

        .chat-area.empty-state {
            align-items: center;
            justify-content: center;
        }

        .chat-area-placeholder {
            text-align: center;
            color: var(--text-muted);
        }
        .chat-area-placeholder .icon-wrap {
            width: 80px;
            height: 80px;
            background: rgba(69,40,105,.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        .chat-area-placeholder p { font-size: 15px; margin-bottom: 4px; }
        .chat-area-placeholder small { font-size: 13px; }

        /* Chat background pattern like WhatsApp */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background-color: #eae6df;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8bfb0' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .messages-container::-webkit-scrollbar { width: 5px; }
        .messages-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 3px; }

        /* â”€â”€â”€ CHAT HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-header {
            background: var(--header-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
        }

        .chat-header .contact-info { flex: 1; min-width: 0; }
        .chat-header .contact-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-header .contact-sub {
            font-size: 12px;
            color: rgba(255,255,255,.7);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online);
            animation: pulse-dot 2s infinite;
            flex-shrink: 0;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .6; transform: scale(.85); }
        }

        /* â”€â”€â”€ DATE DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .date-divider {
            text-align: center;
            margin: 12px 0 8px;
            position: relative;
        }
        .date-divider span {
            background: rgba(225,221,216,.9);
            color: #6b7280;
            font-size: 11.5px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            letter-spacing: .3px;
        }

        /* â”€â”€â”€ MESSAGE BUBBLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg-row {
            display: flex;
            margin: 1px 0;
        }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.received { justify-content: flex-start; }

        .bubble {
            max-width: 68%;
            padding: 7px 10px 6px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,.13);
            position: relative;
            animation: bubble-in .15s ease-out;
            word-wrap: break-word;
            word-break: break-word;
        }
        @keyframes bubble-in {
            from { opacity: 0; transform: scale(.97) translateY(4px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .msg-row.sent  .bubble {
            background: var(--sent-bg);
            border-top-right-radius: 2px;
        }
        .msg-row.received .bubble {
            background: var(--received-bg);
            border-top-left-radius: 2px;
        }

        /* Tail */
        .msg-row.sent .bubble::after {
            content: '';
            position: absolute;
            top: 0;
            right: -8px;
            border: 8px solid transparent;
            border-top-color: var(--sent-bg);
            border-right: 0;
        }
        .msg-row.received .bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            border: 8px solid transparent;
            border-top-color: var(--received-bg);
            border-left: 0;
        }

        /* Template badge */
        .template-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(69,40,105,.1);
            color: var(--brand);
            font-size: 10px;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 10px;
            margin-bottom: 5px;
            letter-spacing: .3px;
            text-transform: uppercase;
        }

        .bubble-image {
            width: 100%;
            max-width: 280px;
            border-radius: 6px;
            display: block;
            margin-bottom: 4px;
            cursor: zoom-in;
            object-fit: cover;
        }

        .bubble-text {
            font-size: 14px;
            line-height: 1.45;
            color: #1a1a1a;
        }

        .bubble-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 3px;
        }

        .bubble-time {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            font-family: 'DM Mono', monospace;
        }
        .msg-row.received .bubble-time { color: #8a9bb0; }

        /* â”€â”€â”€ TICK ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tick { display: inline-flex; align-items: center; }

        .tick-single svg { fill: var(--tick-grey); }
        .tick-double svg { fill: var(--tick-grey); }
        .tick-read   svg { fill: var(--tick-blue); }
        .tick-failed svg { fill: #ef4444; }

        /* â”€â”€â”€ SENDER NAME (group-like) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sender-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--brand);
            margin-bottom: 2px;
        }

        /* â”€â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .input-area {
            background: #f0f2f5;
            padding: 10px 16px;
            border-top: 1px solid #dde0e4;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .input-wrap {
            flex: 1;
            background: #fff;
            border-radius: 24px;
            padding: 9px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border);
            transition: border-color .2s, box-shadow .2s;
            min-height: 44px;
        }
        .input-wrap:focus-within {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(69,40,105,.08);
        }

        .input-wrap input {
            flex: 1;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 14.5px;
            color: var(--text-primary);
            background: transparent;
            min-width: 0;
        }
        .input-wrap input::placeholder { color: var(--text-muted); }

        .attach-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .15s, color .15s;
            flex-shrink: 0;
        }
        .attach-btn:hover { background: #e5e7eb; color: var(--brand); }

        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--brand);
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .15s, transform .1s;
            box-shadow: 0 2px 8px rgba(69,40,105,.35);
            flex-shrink: 0;
        }
        .send-btn:hover { background: var(--brand-light); transform: scale(1.05); }
        .send-btn:active { transform: scale(.95); }

        /* â”€â”€â”€ IMAGE LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.88);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fade-in .2s ease;
        }
        .lightbox.open { display: flex; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        .lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 8px 40px rgba(0,0,0,.5);
        }
        .lightbox-close {
            position: absolute;
            top: 16px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,.15);
            border: none;
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* â”€â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0; top: 0; bottom: 0;
                z-index: 100;
                width: 100%;
                transform: translateX(0);
            }
            .sidebar.hidden { transform: translateX(-100%); }
            .chat-area { width: 100%; }
            .back-btn { display: flex !important; }
            .bubble { max-width: 82%; }
        }

        .back-btn {
            display: none;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,.85);
            border-radius: 50%;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: background .2s;
            flex-shrink: 0;
        }
        .back-btn:hover { background: rgba(255,255,255,.15); }

        /* â”€â”€â”€ LOADING SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(69,40,105,.2);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(60px);
            background: #323232;
            color: #fff;
            font-size: 13px;
            padding: 10px 20px;
            border-radius: 24px;
            box-shadow: var(--shadow-md);
            transition: transform .3s ease, opacity .3s ease;
            opacity: 0;
            z-index: 999;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

<!-- â”€â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="lightbox-close">âœ•</button>
    <img id="lightbox-img" src="" alt="Full image">
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="toast" id="toast"></div>

<div class="app">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sidebar" id="sidebar">

        <div class="sidebar-header">
            <div class="brand">
                <div class="brand-logo">ğŸŸï¸</div>
                <span class="brand-name">Eventio</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" title="New chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </button>
                <button class="icon-btn" title="More options">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="search-wrap">
            <div class="search-inner">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" id="search-input" placeholder="Search conversationsâ€¦">
            </div>
        </div>

        <div id="chats-container">
            <div class="state-empty">
                <div class="spinner"></div>
                <p>Loading conversationsâ€¦</p>
            </div>
        </div>

    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT AREA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="chat-area empty-state" id="chat-area">

        <!-- Shown when no chat selected -->
        <div class="chat-area-placeholder" id="chat-placeholder">
            <div class="icon-wrap">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#452869" stroke-width="1.5">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                </svg>
            </div>
            <p>Select a conversation</p>
            <small>Access cards and replies will appear here</small>
        </div>

        <!-- Chat header (hidden until chat selected) -->
        <div class="chat-header" id="chat-header" style="display:none;">
            <button class="back-btn" id="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 5l-7 7 7 7"/>
                </svg>
            </button>
            <div class="avatar sm" id="header-avatar">?</div>
            <div class="contact-info">
                <div class="contact-name" id="header-name">â€”</div>
                <div class="contact-sub" id="header-sub">
                    <span id="header-status-text">loadingâ€¦</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" title="Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    </svg>
                </button>
                <button class="icon-btn" title="More">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" id="messages-container" style="display:none;"></div>

        <!-- Input -->
        <div class="input-area" id="input-area" style="display:none;">
            <button class="attach-btn" id="emoji-btn" title="Emoji">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </button>
            <div class="input-wrap">
                <input type="text" id="message-input" placeholder="Type a messageâ€¦" autocomplete="off">
                <button class="attach-btn" id="attach-btn" title="Attach image" style="width:28px;height:28px;margin:-4px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
            </div>
            <input type="file" id="image-input" accept="image/*" style="display:none;">
            <button class="send-btn" id="send-btn" title="Send">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>

    </div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const phoneId = "{{ phone_id }}";
let currentWaId       = null;
let currentName       = null;
let lastChatData      = null;
let lastMessageData   = null;
let pollingTimer      = null;

// â”€â”€â”€ TICK SVG HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickSVG(color, double = false) {
    if (!double) {
        return `<svg width="15" height="10" viewBox="0 0 15 10" fill="${color}">
            <path d="M14.2.8a.75.75 0 0 1 0 1.05l-8.5 8.5a.75.75 0 0 1-1.06 0l-4-4A.75.75 0 0 1 1.7 5.3L5.17 8.77 13.15.8a.75.75 0 0 1 1.05 0z"/>
        </svg>`;
    }
    return `<svg width="18" height="10" viewBox="0 0 18 10" fill="${color}">
        <path d="M17.2.8a.75.75 0 0 1 0 1.05l-8.5 8.5a.75.75 0 0 1-1.06 0l-4-4A.75.75 0 0 1 4.7 5.3L8.17 8.77 16.15.8a.75.75 0 0 1 1.05 0zM10.95.8a.75.75 0 0 1 1.05 0l5.2 5.2-1.05 1.05L11 2.38l-.05-.05a.75.75 0 0 1 0-1.53z"/>
    </svg>`;
}

function getTickHTML(status, direction) {
    if (direction !== 'outbound') return '';
    switch ((status || '').toLowerCase()) {
        case 'read':
            return `<span class="tick tick-read" title="Read">${tickSVG('#34b7f1', true)}</span>`;
        case 'delivered':
            return `<span class="tick tick-double" title="Delivered">${tickSVG('#8c9aab', true)}</span>`;
        case 'failed':
            return `<span class="tick tick-failed" title="Failed">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#ef4444">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </span>`;
        case 'sent':
        default:
            return `<span class="tick tick-single" title="Sent">${tickSVG('#8c9aab', false)}</span>`;
    }
}

// â”€â”€â”€ DATE GROUPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDateLabel(dateStr) {
    const d = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
    if (d.toDateString() === today.toDateString()) return 'Today';
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
}

function formatTime(dateStr) {
    return new Date(dateStr).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 3000) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), duration);
}

// â”€â”€â”€ STATUS TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildStatusText(lastTimestamp) {
    if (!lastTimestamp) return 'Offline';
    const diff = (Date.now() - new Date(lastTimestamp)) / 60000;
    if (diff < 2)  return '<span class="status-dot"></span>Online';
    if (diff < 60) return `Last seen ${Math.round(diff)} min ago`;
    if (diff < 1440) {
        return `Last seen today at ${new Date(lastTimestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
    }
    return `Last seen ${new Date(lastTimestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
}

// â”€â”€â”€ FETCH CHATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchChats() {
    try {
        const res  = await fetch(`/api/chats?phone_id=${phoneId}`);
        const data = await res.json();
        if (data.chats) {
            data.chats.sort((a, b) => new Date(b.last_message_timestamp) - new Date(a.last_message_timestamp));
            if (JSON.stringify(data.chats) !== JSON.stringify(lastChatData)) {
                renderChats(data.chats);
                lastChatData = data.chats;
            }
        }
    } catch (e) {
        console.error('fetchChats error:', e);
        if (!lastChatData) {
            document.getElementById('chats-container').innerHTML =
                `<div class="state-empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>Could not load chats. Retryingâ€¦</p></div>`;
        }
    }
}

// â”€â”€â”€ RENDER CHAT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChats(chats) {
    const container = document.getElementById('chats-container');
    if (!chats.length) {
        container.innerHTML = `<div class="state-empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><p>No conversations yet</p></div>`;
        return;
    }

    container.innerHTML = '';
    chats.forEach(chat => {
        const unread  = chat.unread_count || 0;
        const time    = chat.last_message_timestamp ? formatTime(chat.last_message_timestamp) : '';
        const preview = (chat.last_body || 'No messages').substring(0, 48) + ((chat.last_body || '').length > 48 ? 'â€¦' : '');
        const initial = (chat.name || '?')[0].toUpperCase();
        const isActive = currentWaId === chat.wa_id;

        const el = document.createElement('div');
        el.className = `chat-item${isActive ? ' active' : ''}`;
        el.dataset.waId = chat.wa_id;
        el.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="chat-meta">
                <div class="chat-top">
                    <span class="chat-name${unread ? ' unread' : ''}">${escapeHtml(chat.name || 'Unknown')}</span>
                    <span class="chat-time${unread ? ' unread' : ''}">${time}</span>
                </div>
                <div class="chat-phone">+${chat.wa_id}</div>
                <div class="chat-preview-row">
                    <span class="chat-preview${unread ? ' unread' : ''}">${escapeHtml(preview)}</span>
                    ${unread ? `<span class="unread-badge">${unread}</span>` : ''}
                </div>
            </div>`;
        el.addEventListener('click', () => openChat(chat.wa_id, chat.name));
        container.appendChild(el);
    });
}

// â”€â”€â”€ OPEN CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openChat(waId, name, isPolling = false) {
    const mc  = document.getElementById('messages-container');
    const wasAtBottom = mc.scrollHeight - mc.scrollTop <= mc.clientHeight + 10;

    currentWaId  = waId;
    currentName  = name || waId;

    // mobile: hide sidebar
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.add('hidden');
    }

    // show chat UI
    const ca = document.getElementById('chat-area');
    ca.classList.remove('empty-state');
    document.getElementById('chat-placeholder').style.display = 'none';
    document.getElementById('chat-header').style.display      = 'flex';
    document.getElementById('messages-container').style.display = 'flex';
    document.getElementById('messages-container').style.flexDirection = 'column';
    document.getElementById('input-area').style.display       = 'flex';

    // header
    const initial = currentName[0].toUpperCase();
    document.getElementById('header-avatar').textContent = initial;
    document.getElementById('header-name').textContent   = currentName;

    // highlight sidebar item
    document.querySelectorAll('.chat-item').forEach(el => {
        el.classList.toggle('active', el.dataset.waId === waId);
    });

    try {
        const res  = await fetch(`/api/chats/${waId}?phone_id=${phoneId}`);
        const data = await res.json();

        const meta = lastChatData ? lastChatData.find(c => c.wa_id === waId) : null;
        document.getElementById('header-sub').innerHTML = buildStatusText(meta?.last_message_timestamp);

        if (data.messages && (JSON.stringify(data.messages) !== JSON.stringify(lastMessageData) || !isPolling)) {
            lastMessageData = data.messages;
            renderMessages(data.messages);
            if (!isPolling || wasAtBottom) {
                mc.scrollTop = mc.scrollHeight;
            }
        }

        if (!isPolling) {
            await markRead(waId);
            fetchChats();
        }
    } catch (e) {
        console.error('openChat error:', e);
        if (!isPolling) showToast('Could not load messages');
    }
}

// â”€â”€â”€ RENDER MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMessages(messages) {
    const mc = document.getElementById('messages-container');
    mc.innerHTML = '';

    if (!messages || !messages.length) {
        mc.innerHTML = `<div class="state-empty" style="flex:1;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><p>No messages yet â€” start the conversation!</p></div>`;
        return;
    }

    let lastDateLabel = '';

    messages.forEach(msg => {
        const label = formatDateLabel(msg.timestamp);
        if (label !== lastDateLabel) {
            lastDateLabel = label;
            const div = document.createElement('div');
            div.className = 'date-divider';
            div.innerHTML = `<span>${label}</span>`;
            mc.appendChild(div);
        }

        const isSent = msg.direction === 'outbound';
        const row = document.createElement('div');
        row.className = `msg-row ${isSent ? 'sent' : 'received'}`;

        // Build bubble content
        let inner = '';

        // Template badge for outbound template messages
        if (isSent && msg.type === 'template') {
            inner += `<div class="template-badge">ğŸŸï¸ Access Card</div>`;
        }

        // Image
        if (msg.image_url) {
            inner += `<img class="bubble-image" src="${escapeHtml(msg.image_url)}" alt="Access card image"
                onerror="this.style.display='none'"
                onclick="openLightbox('${escapeHtml(msg.image_url)}')">`;
        }

        // Text body
        if (msg.body && msg.body.trim()) {
            inner += `<div class="bubble-text">${escapeHtml(msg.body)}</div>`;
        }

        // Footer: time + ticks
        const time = msg.timestamp ? formatTime(msg.timestamp) : '';
        inner += `<div class="bubble-footer">
            <span class="bubble-time">${time}</span>
            ${getTickHTML(msg.status, msg.direction)}
        </div>`;

        row.innerHTML = `<div class="bubble">${inner}</div>`;
        mc.appendChild(row);
    });
}

// â”€â”€â”€ MARK READ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function markRead(waId) {
    try {
        await fetch('/api/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wa_id: waId, phone_id: phoneId })
        });
    } catch (e) { /* silent */ }
}

// â”€â”€â”€ SEND TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendText(message) {
    if (!currentWaId || !message.trim()) return;

    // Optimistic bubble
    const tempMsg = {
        body: message, direction: 'outbound',
        timestamp: new Date().toISOString(),
        type: 'text', status: 'sent'
    };
    renderMessages([...(lastMessageData || []), tempMsg]);
    const mc = document.getElementById('messages-container');
    mc.scrollTop = mc.scrollHeight;

    try {
        const res  = await fetch('/api/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wa_id: currentWaId, message, phone_id: phoneId, name: currentName })
        });
        const data = await res.json();
        if (res.ok) {
            openChat(currentWaId, currentName);
            fetchChats();
        } else {
            showToast(`Failed: ${data.message}`);
        }
    } catch (e) {
        showToast('Error sending message');
    }
}

// â”€â”€â”€ SEND IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendImage(file) {
    if (!currentWaId || !file) return;
    const caption = document.getElementById('message-input').value.trim();

    const tempMsg = {
        body: caption || 'ğŸ“· Image',
        image_url: URL.createObjectURL(file),
        direction: 'outbound',
        timestamp: new Date().toISOString(),
        type: 'image', status: 'sent'
    };
    renderMessages([...(lastMessageData || []), tempMsg]);
    const mc = document.getElementById('messages-container');
    mc.scrollTop = mc.scrollHeight;
    document.getElementById('message-input').value = '';

    const form = new FormData();
    form.append('wa_id', currentWaId);
    form.append('phone_id', phoneId);
    form.append('image', file);
    form.append('caption', caption);
    form.append('name', currentName);

    try {
        const res  = await fetch('/api/send-image', { method: 'POST', body: form });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('image-input').value = '';
            openChat(currentWaId, currentName);
            fetchChats();
        } else {
            showToast(`Image failed: ${data.message}`);
        }
    } catch (e) {
        showToast('Error sending image');
    }
}

// â”€â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('open');
}
document.getElementById('lightbox-close').addEventListener('click', () => {
    document.getElementById('lightbox').classList.remove('open');
});
document.getElementById('lightbox').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
});

// â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('search-input').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.chat-item').forEach(el => {
        const name    = el.querySelector('.chat-name')?.textContent.toLowerCase() || '';
        const preview = el.querySelector('.chat-preview')?.textContent.toLowerCase() || '';
        el.style.display = (name.includes(q) || preview.includes(q)) ? '' : 'none';
    });
});

// â”€â”€â”€ SEND BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('send-btn').addEventListener('click', () => {
    const inp = document.getElementById('message-input');
    const msg = inp.value.trim();
    if (msg) { inp.value = ''; sendText(msg); }
});
document.getElementById('message-input').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        const msg = inp.value.trim();
        if (msg) { inp.value = ''; sendText(msg); }
    }
});

// â”€â”€â”€ ATTACH IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('attach-btn').addEventListener('click', () => {
    document.getElementById('image-input').click();
});
document.getElementById('image-input').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) sendImage(file);
});

// â”€â”€â”€ BACK BUTTON (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('back-btn').addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('hidden');
    currentWaId = null; currentName = null; lastMessageData = null;
    fetchChats();
});

// â”€â”€â”€ POLLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolling() {
    clearInterval(pollingTimer);
    pollingTimer = setInterval(async () => {
        await fetchChats();
        if (currentWaId && currentName) {
            await openChat(currentWaId, currentName, true);
        }
    }, 5000);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchChats();
startPolling();
</script>
</body>
</html>